<?php include 'config.php';if(!isAdminLoggedIn()){http_response_code(403);echo json_encode(['success'=>false,'message'=>'Unauthorized']);exit;}if($_SERVER['REQUEST_METHOD']!=='POST'){http_response_code(405);echo json_encode(['success'=>false,'message'=>'Method not allowed']);exit;}$input=file_get_contents('php://input');$data=json_decode($input,true);if(!isset($data['id'])||!isset($data['action'])){echo json_encode(['success'=>false,'message'=>'Missing required fields']);exit;}$registrationId=intval($data['id']);$action=$data['action'];$adminUsername=$_SESSION['admin_username']?? 'Admin';try{$database=new Database();$db=$database->getConnection();$query="SELECT * FROM registrations WHERE id = :id";$stmt=$db->prepare($query);$stmt->bindParam(':id',$registrationId);$stmt->execute();if($stmt->rowCount()===0){echo json_encode(['success'=>false,'message'=>'Registration not found']);exit;}$registration=$stmt->fetch(PDO::FETCH_ASSOC);$oldStatus=$registration['status'];$newStatus=$oldStatus;switch($action){case 'approve':$newStatus='approved';break;case 'reject':$newStatus='rejected';break;case 'pending':$newStatus='pending';break;default:echo json_encode(['success'=>false,'message'=>'Invalid action']);exit;}$updateQuery="UPDATE registrations SET status = :status WHERE id = :id";$updateStmt=$db->prepare($updateQuery);$updateStmt->bindParam(':status',$newStatus);$updateStmt->bindParam(':id',$registrationId);if($updateStmt->execute()){$discordSent=sendDiscordStatusUpdate($registrationId,$registration['username'],$oldStatus,$newStatus,$adminUsername);echo json_encode(['success'=>true,'message'=>'Status updated successfully','new_status'=>$newStatus,'discord_notification'=>$discordSent?'sent':'failed']);}else{echo json_encode(['success'=>false,'message'=>'Failed to update status']);}}catch(PDOException $e){error_log("Status update error: ".$e->getMessage());echo json_encode(['success'=>false,'message'=>'Database error']);} ?>