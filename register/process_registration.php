<?php header('Content-Type: application/json');header('Access-Control-Allow-Origin: *');header('Access-Control-Allow-Methods: POST');header('Access-Control-Allow-Headers: Content-Type');include 'config.php';if($_SERVER['REQUEST_METHOD']!=='POST'){http_response_code(405);echo json_encode(['success'=>false,'message'=>'Method not allowed']);exit;}$input=file_get_contents('php://input');$data=json_decode($input,true);if($data===null){$data=$_POST;}$required_fields=['email','username','minecraftType','discord','skills','experience','reason','diamond'];$clean_data=[];foreach($required_fields as $field){if(empty($data[$field])){echo json_encode(['success'=>false,'message'=>'Harap lengkapi semua field yang wajib diisi!']);exit;}$clean_data[$field]=trim(htmlspecialchars($data[$field]));}if(!filter_var($clean_data['email'],FILTER_VALIDATE_EMAIL)){echo json_encode(['success'=>false,'message'=>'Harap masukkan email yang valid!']);exit;}$clean_data['socialMedia']=isset($data['socialMedia'])?trim(htmlspecialchars($data['socialMedia'])):'';try{$database=new Database();$db=$database->getConnection();$check_query="SELECT id FROM registrations WHERE email = :email";$check_stmt=$db->prepare($check_query);$check_stmt->bindParam(':email',$clean_data['email']);$check_stmt->execute();if($check_stmt->rowCount()>0){echo json_encode(['success'=>false,'message'=>'Email ini sudah terdaftar!']);exit;}$query="INSERT INTO registrations \n              (email, username, minecraft_type, discord_username, social_media, skills, experience, reason, diamond_preference) \n              VALUES \n              (:email, :username, :minecraft_type, :discord, :social_media, :skills, :experience, :reason, :diamond)";$stmt=$db->prepare($query);$stmt->bindParam(':email',$clean_data['email']);$stmt->bindParam(':username',$clean_data['username']);$stmt->bindParam(':minecraft_type',$clean_data['minecraftType']);$stmt->bindParam(':discord',$clean_data['discord']);$stmt->bindParam(':social_media',$clean_data['socialMedia']);$stmt->bindParam(':skills',$clean_data['skills']);$stmt->bindParam(':experience',$clean_data['experience']);$stmt->bindParam(':reason',$clean_data['reason']);$stmt->bindParam(':diamond',$clean_data['diamond']);if($stmt->execute()){$newId=$db->lastInsertId();$clean_data['id']=$newId;$discordSent=sendDiscordNotification($clean_data);sendNotificationEmail($clean_data);echo json_encode(['success'=>true,'message'=>'Pendaftaran berhasil dikirim! Kami akan menghubungi Anda melalui email dan Discord atau Whatsapp.','registration_id'=>$newId,'discord_notification'=>$discordSent?'sent':'failed']);}else{echo json_encode(['success'=>false,'message'=>'Terjadi kesalahan saat menyimpan data. Silakan coba lagi.']);}}catch(PDOException $exception){error_log("Database error: ".$exception->getMessage());echo json_encode(['success'=>false,'message'=>'Terjadi kesalahan sistem. Silakan coba lagi nanti.']);}function sendNotificationEmail($data){return true;} ?>